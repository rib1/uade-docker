name: Build UADE CLI Base Image

on:
  # Manual trigger to build specific versions
  workflow_dispatch:
    inputs:
      uade_version:
        description: 'UADE version to build (e.g., 2.13, 2.14). Default: 2.13'
        required: false
        type: string
        default: '2.13'
      build_number:
        description: 'Build number for this UADE version (default: 1 for new version, increment for patches)'
        required: false
        type: string
        default: '1'
      push_latest:
        description: 'Push as latest tag? (only for initial release or major updates)'
        required: false
        type: boolean
        default: false

  # Auto-trigger when Dockerfile changes
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-base-image.yml'

jobs:
  build:
    name: Build UADE CLI Base Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.version.outputs.image_tag }}
      image_url: ${{ steps.version.outputs.image_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse version information
        id: version
        run: |
          # Get input values or use defaults for initial release (2.13-base.1)
          UADE_VERSION="${{ inputs.uade_version }}"
          if [ -z "$UADE_VERSION" ] || [ "$UADE_VERSION" == "2.13" ]; then
            UADE_VERSION="2.13"
          fi
          
          BUILD_NUMBER="${{ inputs.build_number }}"
          if [ -z "$BUILD_NUMBER" ]; then
            BUILD_NUMBER="1"
          fi
          
          IMAGE_TAG="${UADE_VERSION}-base.${BUILD_NUMBER}"
          IMAGE_URL="docker.io/rib1/uade-cli:${IMAGE_TAG}"
          
          echo "uade_version=${UADE_VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT
          
          echo "âœ“ Version parsed: ${IMAGE_TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ steps.version.outputs.image_url }}
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.image_tag }}
            org.opencontainers.image.source=https://github.com/rib1/uade-docker
            org.opencontainers.image.title=UADE CLI Base
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: Verify image runs
        run: |
          docker run --rm ${{ steps.version.outputs.image_url }} --version
          docker run --rm ${{ steps.version.outputs.image_url }} --help

      - name: Push version tags
        run: |
          docker push ${{ steps.version.outputs.image_url }}
          
          # Also push variant tags
          UADE_VERSION=${{ steps.version.outputs.uade_version }}
          docker tag ${{ steps.version.outputs.image_url }} docker.io/rib1/uade-cli:${UADE_VERSION}-base
          docker tag ${{ steps.version.outputs.image_url }} docker.io/rib1/uade-cli:${UADE_VERSION}-base.latest
          
          docker push docker.io/rib1/uade-cli:${UADE_VERSION}-base
          docker push docker.io/rib1/uade-cli:${UADE_VERSION}-base.latest

      - name: Push latest tag
        if: inputs.push_latest || github.event_name == 'push'
        run: |
          docker tag ${{ steps.version.outputs.image_url }} docker.io/rib1/uade-cli:latest
          docker push docker.io/rib1/uade-cli:latest

      - name: Create build summary
        run: |
          cat > /tmp/build-summary.txt << 'EOF'
          # Build Summary: UADE CLI Base Image
          
          Image: ${{ steps.version.outputs.image_url }}
          UADE Version: ${{ steps.version.outputs.uade_version }}
          Build Number: ${{ steps.version.outputs.build_number }}
          
          ## Tags Published
          - ${{ steps.version.outputs.image_tag }} (specific version+build)
          - ${{ steps.version.outputs.uade_version }}-base (latest for this UADE version)
          - ${{ steps.version.outputs.uade_version }}-base.latest (pinned latest patch)
          - latest (global latest, if specified)
          
          ## For Initial Release (2.13-base.1)
          - Image is production-ready for Dockerfile.web
          - All tags point to the same image
          - Pin Dockerfile.web to: uade-cli:2.13-base.1
          
          ## For Future Updates
          - Patch releases: Increment build_number (2.13-base.2, etc.)
          - Major updates: New UADE version (2.14-base.1, etc.)
          - Always run E2E tests before updating Dockerfile.web
          EOF
          cat /tmp/build-summary.txt

      - name: Upload build summary
        uses: actions/upload-artifact@v4
        with:
          name: build-summary
          path: /tmp/build-summary.txt
          retention-days: 30

  test-integration:
    name: Test Base Image Integration
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || inputs.push_latest == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      - name: Install Playwright browsers
        working-directory: tests
        run: npx playwright install --with-deps chromium

      - name: Build web player with new base image
        env:
          UADE_CLI_VERSION: ${{ needs.build.outputs.image_tag }}
        run: |
          # Update Dockerfile.web to use new base image
          sed -i "s|FROM uade-cli:.*|FROM uade-cli:${{ needs.build.outputs.image_tag }}|" Dockerfile.web
          docker build -f Dockerfile.web -t uade-web:test .

      - name: Start test environment
        run: |
          docker run -d -p 5000:5000 \
            --name uade-test \
            uade-web:test

      - name: Wait for service
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5000/health; do sleep 2; done'

      - name: Run API tests
        working-directory: tests
        run: npm run test:api
        env:
          BASE_URL: http://localhost:5000

      - name: Run integration tests
        working-directory: tests
        run: npm run test:integration
        env:
          BASE_URL: http://localhost:5000

      - name: Cleanup
        if: always()
        run: |
          docker stop uade-test || true
          docker rm uade-test || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: tests/playwright-report/
          retention-days: 30
