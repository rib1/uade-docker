name: Build UADE CLI Base Image

on:
  # Manual trigger to build specific versions
  workflow_dispatch:
    inputs:
      uade_version:
        description: 'UADE version to build (e.g., 3.05, 3.06). Default: 3.05'
        required: false
        type: string
        default: '3.05'
      build_number:
        description: 'Build number for this UADE version (default: 1 for new version, increment for patches)'
        required: false
        type: string
        default: '1'
      push_latest:
        description: 'Push as latest tag? (only for initial release or major updates)'
        required: false
        type: boolean
        default: false

  # Auto-trigger when Dockerfile changes
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-base-image.yml'

jobs:
  build:
    name: Build UADE CLI Base Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: write

    outputs:
      image_tag: ${{ steps.version.outputs.image_tag }}
      image_url: ${{ steps.version.outputs.image_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse version information
        id: version
        run: |
          # Get input values or use defaults for initial release (3.05-base.1)
          UADE_VERSION="${{ inputs.uade_version }}"
          if [ -z "$UADE_VERSION" ] || [ "$UADE_VERSION" == "3.05" ]; then
            UADE_VERSION="3.05"
          fi
          
          BUILD_NUMBER="${{ inputs.build_number }}"
          if [ -z "$BUILD_NUMBER" ]; then
            BUILD_NUMBER="1"
          fi
          
          IMAGE_TAG="${UADE_VERSION}-base.${BUILD_NUMBER}"
          IMAGE_URL="gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:${IMAGE_TAG}"
          
          echo "uade_version=${UADE_VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT
          
          echo "âœ“ Version parsed: ${IMAGE_TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build Docker image
        run: |
          docker build -f Dockerfile \
            -t ${{ steps.version.outputs.image_url }} \
            -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:${{ steps.version.outputs.uade_version }}-base \
            -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:latest \
            --label org.opencontainers.image.version=${{ steps.version.outputs.image_tag }} \
            --label org.opencontainers.image.source=https://github.com/rib1/uade-docker \
            --label org.opencontainers.image.title="UADE CLI Base" \
            .

      - name: Verify image runs
        run: |
          docker run --rm ${{ steps.version.outputs.image_url }} --version
          docker run --rm ${{ steps.version.outputs.image_url }} --help

      - name: Push image to Google Container Registry
        run: |
          echo "Pushing to GCR: ${{ steps.version.outputs.image_url }}"
          docker push ${{ steps.version.outputs.image_url }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:${{ steps.version.outputs.uade_version }}-base
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:latest

      - name: Create build summary
        run: |
          cat > /tmp/build-summary.txt << 'EOF'
          # Build Summary: UADE CLI Base Image
          
          Image: ${{ steps.version.outputs.image_url }}
          UADE Version: ${{ steps.version.outputs.uade_version }}
          Build Number: ${{ steps.version.outputs.build_number }}
          Registry: Google Container Registry (GCR)
          
          ## Tags Published to GCR
          - gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:${{ steps.version.outputs.image_tag }}
          - gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:${{ steps.version.outputs.uade_version }}-base
          - gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:latest
          
          ## For Initial Release (3.05-base.1)
          - Image is production-ready for Dockerfile.web
          - All tags point to the same image
          - Pin Dockerfile.web to: gcr.io/${{ secrets.GCP_PROJECT_ID }}/uade-cli:3.05-base.1
          
          ## For Future Updates
          - Patch releases: Increment build_number (3.05-base.2, etc.)
          - Major updates: New UADE version (3.06-base.1, etc.)
          - Always run E2E tests before updating Dockerfile.web
          EOF
          cat /tmp/build-summary.txt

      - name: Upload build summary
        uses: actions/upload-artifact@v4
        with:
          name: build-summary
          path: /tmp/build-summary.txt
          retention-days: 30

      - name: Trigger verify-uade-version workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering verify-uade-version workflow on main..."
          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/workflows/verify-uade-version.yml/dispatches"
          IMAGE_URL="${{ steps.version.outputs.image_url }}"
          PAYLOAD=$(jq -n --arg ref "main" --arg img "$IMAGE_URL" '{ref: $ref, inputs: {image_url: $img}}')
          echo "Dispatch payload: $PAYLOAD"
          curl -s -X POST "$API_URL" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d "$PAYLOAD"

  test-integration:
    name: Test Base Image Integration
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    if: github.event_name == 'push' || inputs.push_latest == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      - name: Install Playwright browsers
        working-directory: tests
        run: npx playwright install --with-deps chromium

      - name: Build web player with new base image
        run: |
          # Update Dockerfile.web BASE_IMAGE ARG to use new base image from GCR
          sed -i "s|ARG BASE_IMAGE=.*|ARG BASE_IMAGE=${{ needs.build.outputs.image_url }}|" Dockerfile.web
          docker build -f Dockerfile.web -t uade-web:test . \
            --build-arg BASE_IMAGE="${{ needs.build.outputs.image_url }}"

      - name: Start test environment
        run: |
          docker run -d -p 5000:5000 \
            --name uade-test \
            uade-web:test

      - name: Wait for service
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5000/health; do sleep 2; done'

      - name: Run API tests
        working-directory: tests
        run: npm run test:api
        env:
          BASE_URL: http://localhost:5000

      - name: Run integration tests
        working-directory: tests
        run: npm run test:integration
        env:
          BASE_URL: http://localhost:5000

      - name: Cleanup
        if: always()
        run: |
          docker stop uade-test || true
          docker rm uade-test || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: tests/playwright-report/
          retention-days: 30
