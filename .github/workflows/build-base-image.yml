name: Build UADE CLI Base Image

on:
  # Manual trigger to build specific versions
  workflow_dispatch:
    inputs:
      uade_version:
        description: 'UADE version to build (e.g., 3.05, 3.06). Default: 3.05'
        required: false
        type: string
        default: '3.05'
      build_number:
        description: 'Build number for this UADE version (default: 1 for new version, increment for patches)'
        required: false
        type: string
        default: '1'
      push_latest:
        description: 'Push as latest tag? (only for initial release or major updates)'
        required: false
        type: boolean
        default: false

  # Auto-trigger when Dockerfile changes
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-base-image.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-base-image.yml'
permissions:
  contents: read
  packages: write

jobs:
  build-base:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Parse version information
      id: version
      run: |
        # Get input values or use defaults for initial release (3.05-base.1)
        UADE_VERSION="${{ inputs.uade_version }}"
        if [ -z "$UADE_VERSION" ] || [ "$UADE_VERSION" == "3.05" ]; then
          UADE_VERSION="3.05"
        fi
        
        BUILD_NUMBER="${{ inputs.build_number }}"
        if [ -z "$BUILD_NUMBER" ]; then
          BUILD_NUMBER="1"
        fi
        IMAGE_TAG="${UADE_VERSION}-base.${BUILD_NUMBER}"
        IMAGE_URL="ghcr.io/${{ github.repository_owner }}/uade-cli:${IMAGE_TAG}"
        echo "uade_version=${UADE_VERSION}" >> $GITHUB_OUTPUT
        echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT
        echo "✓ Version parsed: ${IMAGE_TAG}"
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ steps.version.outputs.image_url }}
          ghcr.io/${{ github.repository_owner }}/uade-cli:${{ steps.version.outputs.uade_version }}-base
          ghcr.io/${{ github.repository_owner }}/uade-cli:latest
        cache-from: type=gha,scope=cli
        cache-to: type=gha,mode=max,scope=cli
    - name: Verify image runs
      run: |
        docker run --rm ${{ steps.version.outputs.image_url }} --version
        docker run --rm ${{ steps.version.outputs.image_url }} --help


    - name: Create build summary
      run: |
        cat > /tmp/build-summary.txt << 'EOF'
        # Build Summary: UADE CLI Base Image

        Image: ${{ steps.version.outputs.image_url }}
        UADE Version: ${{ steps.version.outputs.uade_version }}
        Build Number: ${{ steps.version.outputs.build_number }}
        Registry: GitHub Container Registry (GHCR)

        ## Tags Published to GHCR
        - ghcr.io/${{ github.repository_owner }}/uade-cli:${{ steps.version.outputs.image_tag }}
        - ghcr.io/${{ github.repository_owner }}/uade-cli:${{ steps.version.outputs.uade_version }}-base
        - ghcr.io/${{ github.repository_owner }}/uade-cli:latest

        ## For Initial Release (3.05-base.1)
        - Image is production-ready for Dockerfile.web
        - All tags point to the same image
        - Pin Dockerfile.web to: ghcr.io/${{ github.repository_owner }}/uade-cli:3.05-base.1

        ## For Future Updates
        - Patch releases: Increment build_number (3.05-base.2, etc.)
        - Major updates: New UADE version (3.06-base.1, etc.)
        - Always run E2E tests before updating Dockerfile.web
        EOF
        cat /tmp/build-summary.txt

    - name: Verify UADE executable work
      run: |
        docker run --rm ${{ steps.version.outputs.image_url }} uade123 --help

    - name: Confirm UADE version matches input
      run: |
        EXPECTED_VERSION="${{ steps.version.outputs.uade_version }}"
        ACTUAL_VERSION=$(docker run --rm ${{ steps.version.outputs.image_url }} uade123 --version | grep -oP 'uade123 \K[0-9.]+' || echo "unknown")
        echo "Expected: $EXPECTED_VERSION"
        echo "Actual:   $ACTUAL_VERSION"
        if [ "$ACTUAL_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "❌ UADE version mismatch!"
          exit 1
        fi
        echo "✅ UADE version matches input"

    - name: Upload build summary
      uses: actions/upload-artifact@v5
      with:
        name: build-summary
        path: /tmp/build-summary.txt
        retention-days: 30
