name: Build UADE CLI Base Image

on:
  # Manual trigger to build specific versions
  workflow_dispatch:
    inputs:
      uade_version:
        description: 'UADE version to build (e.g., 3.05, 3.06). Default: 3.05'
        required: false
        type: string
        default: '3.05'
      build_number:
        description: 'Build number for this UADE version (default: 1 for new version, increment for patches)'
        required: false
        type: string
        default: '1'
      push_latest:
        description: 'Push as latest tag? (only for initial release or major updates)'
        required: false
        type: boolean
        default: false

  # Auto-trigger when Dockerfile changes
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-base-image.yml'

jobs:
  build-base:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Parse version information
      id: version
      run: |
        # Get input values or use defaults for initial release (3.05-base.1)
        UADE_VERSION="${{ inputs.uade_version }}"
        if [ -z "$UADE_VERSION" ] || [ "$UADE_VERSION" == "3.05" ]; then
          UADE_VERSION="3.05"
        fi
        
        BUILD_NUMBER="${{ inputs.build_number }}"
        jobs:
          build-base:
            runs-on: ubuntu-latest
            steps:
              - name: Checkout code
                uses: actions/checkout@v5

              - name: Parse version information
                id: version
                run: |
                  UADE_VERSION="${{ inputs.uade_version }}"
                  if [ -z "$UADE_VERSION" ] || [ "$UADE_VERSION" == "3.05" ]; then
                    UADE_VERSION="3.05"
                  fi
                  BUILD_NUMBER="${{ inputs.build_number }}"
                  if [ -z "$BUILD_NUMBER" ]; then
                    BUILD_NUMBER="1"
                  fi
                  IMAGE_TAG="${UADE_VERSION}-base.${BUILD_NUMBER}"
                  IMAGE_URL="ghcr.io/${{ github.repository_owner }}/uade-player:${IMAGE_TAG}"
                  echo "uade_version=${UADE_VERSION}" >> $GITHUB_OUTPUT
                  echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
                  echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
                  echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT
                  echo "âœ“ Version parsed: ${IMAGE_TAG}"

              - name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

              - name: Log in to GitHub Container Registry
                uses: docker/login-action@v3
                with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

              - name: Build Docker image
                run: |
                  docker build -f Dockerfile \
                    -t ${{ steps.version.outputs.image_url }} \
                    -t ghcr.io/${{ github.repository_owner }}/uade-player:${{ steps.version.outputs.uade_version }}-base \
                    -t ghcr.io/${{ github.repository_owner }}/uade-player:latest \
                    --label org.opencontainers.image.version=${{ steps.version.outputs.image_tag }} \
                    --label org.opencontainers.image.source=https://github.com/rib1/uade-docker \
                    --label org.opencontainers.image.title="UADE CLI Base" \
                    .

              - name: Verify image runs
                run: |
                  docker run --rm ${{ steps.version.outputs.image_url }} --version
                  docker run --rm ${{ steps.version.outputs.image_url }} --help

              - name: Push image to GitHub Container Registry
                run: |
                  echo "Pushing to GHCR: ${{ steps.version.outputs.image_url }}"
                  docker push ${{ steps.version.outputs.image_url }}
                  docker push ghcr.io/${{ github.repository_owner }}/uade-player:${{ steps.version.outputs.uade_version }}-base
                  docker push ghcr.io/${{ github.repository_owner }}/uade-player:latest

              - name: Create build summary
                run: |
                  cat > /tmp/build-summary.txt << 'EOF'
                  # Build Summary: UADE CLI Base Image
          
                  Image: ${{ steps.version.outputs.image_url }}
                  UADE Version: ${{ steps.version.outputs.uade_version }}
                  Build Number: ${{ steps.version.outputs.build_number }}
                  Registry: GitHub Container Registry (GHCR)
          
                  ## Tags Published to GHCR
                  - ghcr.io/${{ github.repository_owner }}/uade-player:${{ steps.version.outputs.image_tag }}
                  - ghcr.io/${{ github.repository_owner }}/uade-player:${{ steps.version.outputs.uade_version }}-base
                  - ghcr.io/${{ github.repository_owner }}/uade-player:latest
          
                  ## For Initial Release (3.05-base.1)
                  - Image is production-ready for Dockerfile.web
                  - All tags point to the same image
                  - Pin Dockerfile.web to: ghcr.io/${{ github.repository_owner }}/uade-player:3.05-base.1
          
                  ## For Future Updates
                  - Patch releases: Increment build_number (3.05-base.2, etc.)
                  - Major updates: New UADE version (3.06-base.1, etc.)
                  - Always run E2E tests before updating Dockerfile.web
                  EOF
                  cat /tmp/build-summary.txt

              - name: Upload build summary
                uses: actions/upload-artifact@v4
                with:
                  name: build-summary
                  path: /tmp/build-summary.txt
                  retention-days: 30
